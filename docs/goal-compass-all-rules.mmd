graph TB
    subgraph Backend["ğŸ”§ Backend - Goal Compass Rule Engine"]
        direction TB
        
        subgraph RuleEngine["Rule Engine Architecture"]
            Registry[RuleRegistry<br/>ğŸ“ Auto-registration<br/>ğŸ”§ Enable/Disable<br/>ğŸ“Š Priority Management]
            BaseRule[GoalRule Base Class<br/>ğŸ“‹ Abstract Interface<br/>âš™ï¸ apply method]
        end
        
        subgraph Rules["ğŸ“‹ All Rules (Executed in Priority Order)"]
            direction LR
            
            Rule1["1ï¸âƒ£ SurplusIncomeRule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Priority: 20 (First)<br/>Trigger: Income > baseline<br/>Action: Suggest allocation<br/>to top drifting goal"]
            
            Rule2["2ï¸âƒ£ OverspendingRule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Priority: 30 (Second)<br/>Trigger: Debit in<br/>discretionary category<br/>Action: Warning signal +<br/>suggest expense cut"]
            
            Rule3["3ï¸âƒ£ DriftRule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Priority: 40 (Last)<br/>Trigger: After drift calc<br/>on all goals<br/>Action: Drift signals +<br/>suggest contribution boost"]
        end
        
        subgraph CoreServices["Core Services"]
            Engine[GoalRealtimeEngine<br/>Main orchestrator]
            Planner[GoalPlanner<br/>Priority & projections]
            Hook[Transaction Hook<br/>Entry point]
        end
        
        subgraph DataLayer["Data Layer"]
            GoalsRepo[GoalsRepository<br/>Goal CRUD operations]
            SignalsRepo[GoalSignalsRepository<br/>Signal management]
            SuggestionsRepo[GoalSuggestionsRepository<br/>Suggestion management]
        end
        
        subgraph APIEndpoints["REST API Endpoints"]
            SignalsEP[GET /v1/goals/signals<br/>Fetch all signals]
            SuggestionsEP[GET /v1/goals/suggestions<br/>Fetch open suggestions]
            UpdateEP[PATCH /v1/goals/suggestions/:id<br/>Update suggestion status]
        end
        
        subgraph Database["PostgreSQL Tables"]
            GoalsDB[goal.user_goals_master<br/>+ drift_amount<br/>+ drift_pct<br/>+ last_contribution_at]
            SignalsDB[goal.goal_signals<br/>signal_type, severity<br/>message, meta]
            SuggestionsDB[goal.goal_suggestions<br/>suggestion_type, title<br/>description, action_payload]
            ConfigDB[goal.rule_config<br/>Optional: Dynamic config]
        end
        
        subgraph RuleFiles["Rule Implementation Files"]
            RuleFile1[app/goals/rules/<br/>surplus_income.py]
            RuleFile2[app/goals/rules/<br/>overspending.py]
            RuleFile3[app/goals/rules/<br/>drift_rule.py]
            RuleBase[app/goals/rules/<br/>base_rule.py]
            RuleInit[app/goals/rules/<br/>__init__.py]
        end
    end
    
    subgraph Frontend["âš›ï¸ Frontend - React/TypeScript"]
        direction TB
        
        subgraph UIComponents["UI Components"]
            InsightsPanel["GoalInsightsPanel<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ“Š Displays signals<br/>ğŸ¨ Color-coded severity<br/>â° Shows timestamps<br/>ğŸ”” Alert indicators"]
            
            SuggestionsList["GoalSuggestionsList<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>âœ… Accept/Dismiss buttons<br/>ğŸ’° Shows suggested amounts<br/>ğŸ“ Actionable recommendations<br/>ğŸ”„ Auto-refresh on action"]
            
            GoalsScreen["GoalsScreen<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ“± Main dashboard<br/>ğŸ”— Integrates both panels<br/>ğŸ“‹ Goals list view"]
        end
        
        subgraph APIClient["API Client Layer"]
            GoalsAPI["goals.ts<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>fetchGoalSignals<br/>fetchGoalSuggestions<br/>updateGoalSuggestionStatus"]
        end
        
        subgraph TypeDefinitions["TypeScript Types"]
            SignalType["GoalSignal<br/>id, goal_id, signal_type<br/>severity, message, meta"]
            SuggestionType["GoalSuggestion<br/>id, goal_id, type<br/>title, description<br/>action_payload, status"]
        end
        
        subgraph FrontendFiles["Frontend Files"]
            FrontendFile1[src/components/goals/<br/>GoalInsightsPanel.tsx]
            FrontendFile2[src/components/goals/<br/>GoalSuggestionsList.tsx]
            FrontendFile3[src/features/goals/<br/>GoalsScreen.tsx]
            FrontendFile4[src/api/goals.ts]
            FrontendFile5[src/types/goals.ts]
        end
    end
    
    subgraph Monyweb["ğŸŒ Monyweb - Next.js"]
        direction TB
        
        subgraph NextPages["Next.js Pages"]
            GoalsPage["Goals Page<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ğŸ”„ Server/Client components<br/>ğŸ“¡ API integration<br/>ğŸ¨ Next.js styling"]
        end
        
        subgraph NextIntegration["Integration Layer"]
            NextAPI["API Integration<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Calls backend endpoints<br/>Server-side rendering<br/>Client-side hydration"]
        end
        
        subgraph MonywebFiles["Monyweb Files"]
            NextFile1[app/goals/<br/>page.tsx or route]
            NextFile2[app/goals/<br/>components/]
        end
    end
    
    %% Backend Internal Connections
    Hook --> Engine
    Engine --> Planner
    Engine --> Registry
    Registry --> BaseRule
    Registry --> Rule1
    Registry --> Rule2
    Registry --> Rule3
    
    Rule1 --> RuleFile1
    Rule2 --> RuleFile2
    Rule3 --> RuleFile3
    BaseRule --> RuleBase
    Registry --> RuleInit
    
    Rule1 --> GoalsRepo
    Rule1 --> SignalsRepo
    Rule1 --> SuggestionsRepo
    Rule2 --> GoalsRepo
    Rule2 --> SignalsRepo
    Rule2 --> SuggestionsRepo
    Rule3 --> GoalsRepo
    Rule3 --> SignalsRepo
    Rule3 --> SuggestionsRepo
    
    GoalsRepo --> GoalsDB
    SignalsRepo --> SignalsDB
    SuggestionsRepo --> SuggestionsDB
    Registry --> ConfigDB
    
    SignalsEP --> SignalsRepo
    SuggestionsEP --> SuggestionsRepo
    UpdateEP --> SuggestionsRepo
    
    %% Frontend Connections
    GoalsScreen --> InsightsPanel
    GoalsScreen --> SuggestionsList
    InsightsPanel --> GoalsAPI
    SuggestionsList --> GoalsAPI
    GoalsAPI --> SignalType
    GoalsAPI --> SuggestionType
    GoalsAPI --> SignalsEP
    GoalsAPI --> SuggestionsEP
    GoalsAPI --> UpdateEP
    
    InsightsPanel --> FrontendFile1
    SuggestionsList --> FrontendFile2
    GoalsScreen --> FrontendFile3
    GoalsAPI --> FrontendFile4
    SignalType --> FrontendFile5
    SuggestionType --> FrontendFile5
    
    %% Monyweb Connections
    GoalsPage --> NextAPI
    NextAPI --> SignalsEP
    NextAPI --> SuggestionsEP
    NextAPI --> UpdateEP
    GoalsPage --> NextFile1
    NextAPI --> NextFile2
    
    %% Styling
    classDef backend fill:#2563eb,stroke:#1e40af,stroke-width:3px,color:#fff
    classDef frontend fill:#10b981,stroke:#059669,stroke-width:3px,color:#fff
    classDef monyweb fill:#f59e0b,stroke:#d97706,stroke-width:3px,color:#fff
    classDef rules fill:#8b5cf6,stroke:#7c3aed,stroke-width:2px,color:#fff
    classDef database fill:#ef4444,stroke:#dc2626,stroke-width:2px,color:#fff
    classDef registry fill:#06b6d4,stroke:#0891b2,stroke-width:2px,color:#fff
    classDef files fill:#64748b,stroke:#475569,stroke-width:1px,color:#fff
    
    class Engine,Planner,Hook,GoalsRepo,SignalsRepo,SuggestionsRepo,SignalsEP,SuggestionsEP,UpdateEP backend
    class InsightsPanel,SuggestionsList,GoalsScreen,GoalsAPI,SignalType,SuggestionType frontend
    class GoalsPage,NextAPI monyweb
    class Rule1,Rule2,Rule3 rules
    class GoalsDB,SignalsDB,SuggestionsDB,ConfigDB database
    class Registry,BaseRule registry
    class RuleFile1,RuleFile2,RuleFile3,RuleBase,RuleInit,FrontendFile1,FrontendFile2,FrontendFile3,FrontendFile4,FrontendFile5,NextFile1,NextFile2 files

